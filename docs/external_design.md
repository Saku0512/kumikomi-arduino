# 外部設計書 (External Design Document)

## 1. システム概要
本システムは、アナログジョイスティックを用いた直感的な操作により、PCの画面ロックおよびロック解除を行う組み込み認証デバイスである。
Raspberry Pi Picoを制御中核とし、PC上のコンパニオンアプリ（Pythonスクリプト）とシリアル通信で連携する。

### 1.1 システム構成
```mermaid
graph LR
    User(ユーザー)
    subgraph Device [認証デバイス (Raspberry Pi Pico)]
        UI[LCD / LED]
        Input[ジョイスティック]
        Logic[制御ロジック]
    end
    subgraph PC [ホストPC]
        Listener[常駐スクリプト]
        LockApp[ロック画面アプリ]
    end

    User --> Input
    Input --> Logic
    Logic --> UI
    Logic == "Serial (USB)" ==> Listener
    Listener --> LockApp
```

## 2. ハードウェア構成

### 2.1 主要コンポーネント
| 部品名 | 役割 | 備考 |
|:---|:---|:---|
| Raspberry Pi Pico | メインコントローラ | Arduino Frameworkで動作 |
| アナログジョイスティック | 認証コード入力、モード切替操作 | X/Y軸(アナログ), Z軸(スイッチ) |
| LCD (16x2) | 状態表示、操作ガイド | I2C接続ではない (パラレル接続) |
| LED | 状態表示（ロック解除時など） | GPIO制御 |

### 2.2 ピンアサイン (Pin Assignment)
`src/main.cpp` の定義に基づく。

| ピン番号 (GPIO) | 接続機能 | 備考 |
|:---|:---|:---|
| 9, 10, 12, 13, 14, 15 | LCD | RS, EN, D4, D5, D6, D7 |
| 27 (ADC1) | Joystick X | 左右 (ピン定義変更の形跡あり) |
| 26 (ADC0) | Joystick Y | 上下 |
| 28 | Joystick Z | 押し込みボタン (INPUT_PULLUP) |
| 25 | LED | 本体LED または 外部LED |

## 3. ユーザインターフェース (UI) 仕様

### 3.1 画面遷移と操作モード

LCDの表示内容は以下の状態により変化する。

1.  **待機状態 (Idle)**
    *   **表示:**
        *   1行目: `Right 3s: Set` (パスワード未設定時のみ)
        *   2行目: `Up 3s: Unlock`
    *   **操作:**
        *   **右 3秒長押し**: パスワード設定モードへ遷移
        *   **上 3秒長押し**: 認証（ロック）モードへ遷移
        *   **下 3秒長押し**: デバッグリセット（パスワード消去等）

2.  **カウントダウン (Countdown)**
    *   長押し操作中、残り秒数を表示する。
    *   **表示例:** `Hold UP: 2s`

3.  **パスワード設定モード (Set Password)**
    *   **概要:** 4回分の方向入力を受け付け、新しいパスワードとして保存する。
    *   **表示:** `Input #1 [ ]` -> 入力後 `Input #1 [UP ]` (確認表示)
    *   **完了時:** `Password Saved!` 表示後、待機状態へ戻る。

4.  **認証モード (Authentication)**
    *   **概要:** パスワード入力を求め、PCのロック操作を行う。
    *   **開始時:** PCへ `!!LOCK!!` コマンドを送信。PC側でロック画面が起動。
    *   **表示:** `Enter Code #1`
    *   **入力フィードバック:** `* ACCEPTED *`
    *   **成功時:**
        *   PCへ `!!UNLOCK!!` コマンドを送信。
        *   LCD: `!!UNLOCK!!`
        *   LED: 3秒間点灯
    *   **失敗時:**
        *   LCD: `Auth Failed...`
        *   PCのロックは解除されない。

### 3.2 入力仕様 (Joystick)
*   **方向判定:** アナログ値の偏差が閾値（200）を超えた場合に入力とみなす。
*   **誤入力防止 (Debounce/Centering):**
    *   一度入力判定された後、スティックが**中心 (Center)** に戻るまで次の入力を受け付けない。
    *   これにより、「右」から「上」へ直接スライドさせた場合などの意図しない連続入力を防ぐ。

## 4. 通信インターフェース仕様

PCとの連携にはUSBシリアル通信（CDC）を使用する。

*   **ボーレート:** 9600 または 115200 bps
*   **データ形式:** ASCIIテキスト, 改行コード終端

### 4.1 コマンド一覧 (Device -> PC)

| コマンド文字列 | 送信タイミング | PC側の動作 |
|:---|:---|:---|
| `!!LOCK!!` | 認証モード開始時 (上長押し完了時) | 全画面のロックウィンドウ (`lock_screen.py`) を起動し、操作を不能にする。 |
| `!!UNLOCK!!` | 認証成功時 | ロックウィンドウを終了し、一時的に `unlock_screen.py` を表示して復帰する。 |

## 5. 機能要件

### 5.1 コンパニオンアプリ (PC用)
*   **Listener (`listener.py`):**
    *   指定されたシリアルポートを常時監視する。
    *   接続断検知時に自動再接続を試みる。
    *   コマンド受信時にサブプロセスとしてGUIスクリプトを起動/終了する。
*   **Lock Screen (`lock_screen.py`):**
    *   全画面表示で入力をブロック、または黒画面等で覆う。
    *   `Alt+F4` 等の標準的な終了操作を無効化することが望ましい（現状の実装レベルによる）。

### 5.2 安全性・制約事項
*   **パスワード保存:** 現状のファームウェアではRAM上に保存されるため、**電源断によりリセット**される（初期値: 上・上・上・上）。
*   **セキュリティ強度:** 4方向 × 4回 = 256通り。簡易的なロックであり、高度なセキュリティを保証するものではない。
